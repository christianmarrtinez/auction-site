{% extends "auctions/layout.html" %}

{% load tz %}
{% load static %}

{% block scripts %}
<script src="{% static 'auctions/js/bid_input.js' %}"></script>
{% endblock %}


{% block body %}
<h2>{{ listing.title }}</h2>

{% if listing.image %}
  <img src="{{ listing.image.url }}" alt="{{ listing.title }}" style="max-width: 100%;">
{% endif %}


<p><strong>Description:</strong> {{ listing.description }}</p>
<p><strong>Current Price:</strong> ${{ current_price }}</p>

{% if user.is_authenticated %}
    <h3>Place a Bid</h3>
    <form method="POST">
        {% csrf_token %}
        <input 
            type="number" 
            name="amount" 
            class="form-control bid-input" 
            placeholder="00.00" 
            step="0.01" 
            min="0.01"
            required>
        <button type="submit" class="btn btn-primary">Place Bid</button>
    </form>
    {% if messages %}
        <ul>
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
{% else %}
    <p><a href="{% url 'login' %}">Log in</a> to place a bid.</p>
{% endif %}

<h3>Bids</h3>
{% if bids %}
    <ul>
    {% for bid in bids %}
        <li>{{ bid.bidder.username }} bid ${{ bid.amount }}</li>
    {% endfor %}
    </ul>
{% else %}
    <p>No bids yet. Be the first to bid!</p>
{% endif %}

<h3>Comments</h3>
{% if comments %}
    <ul>
    {% for comment in listing.comments.all %}
        <div class="comment">
            <p><strong>{{ comment.author.username }}:</strong> {{ comment.content }}</p>
            <p><small>Commented at:</small> {{ comment.timestamp|localtime|date:"Y-m-d H:i:s" }}</p>
        </div>
{% endfor %}
    </ul>
{% else %}
    <p>No comments yet. Be the first to comment!</p>
{% endif %}

{% if user.is_authenticated %}
    <h3>Add a Comment</h3>
    <form method="POST">
        {% csrf_token %}
        <textarea name="comment_content" class="form-control" rows="4" placeholder="Write your comment here..." required></textarea>
        <button type="submit" name="comment" value="1" class="btn btn-primary">Add Comment</button>
    </form>
{% else %}
    <p><a href="{% url 'login' %}">Log in</a> to add a comment.</p>
{% endif %}

<form action="{% url 'toggle_watchlist' listing.id %}" method="post" style="display: inline-block;">
    {% csrf_token %}
    <button 
        type="submit" 
        name="action" 
        value="add" 
        class="btn btn-primary"
        {% if user.id in listing_watchlist_users %}disabled{% endif %}>
        Add to Watchlist
    </button>
</form>

<form action="{% url 'toggle_watchlist' listing.id %}" method="post" style="display: inline-block; margin-left: 10px;">
    {% csrf_token %}
    <button 
        type="submit" 
        name="action" 
        value="remove" 
        class="btn btn-danger"
        {% if user.id not in listing_watchlist_users %}disabled{% endif %}>
        Remove from Watchlist
    </button>
</form>

{% if not listing.is_active %}
    {% if is_user_winner %}
        <h3>Congratulations! You have won this auction with a bid of ${{ current_price }}.</h3>
    {% elif winner %}
        <h3>This auction is closed. The winner is {{ winner.username }} with a final bid of ${{ current_price }}.</h3>
    {% else %}
        <h3>This auction is closed. No winning bid was placed.</h3>
    {% endif %}
{% endif %}

{% if user == listing.owner and listing.is_active %}
    <form method="POST" style="margin-top: 20px;">
        {% csrf_token %}
        <button type="submit" name="close_auction" value="1" class="btn btn-danger">Close Auction</button>
    </form>

    <a href="{% url 'edit_listing' listing.id %}" class="btn btn-warning">Edit Listing</a>
{% endif %}

<a href="{% url 'index' %}" class="btn btn-primary">Back to Active Listings</a>
{% endblock %}